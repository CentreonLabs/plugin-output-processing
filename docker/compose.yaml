services:

  pop:
    image: centreonlabs/pop
    container_name: pop-api
    ports:
      - 8000:8000
    environment:
      - POP_CONFIG_PATH=${POP_CONFIG_PATH:-/root/.pop/config.yaml}
      - OLLAMA_HOST=${OLLAMA_HOST:-ollama}
    volumes:
      - pop:/root/.pop
    networks:
      - pop
    depends_on:
      init-ollama:
        condition: service_completed_successfully
    
  ollama:
    container_name: pop-ollama
    image: ollama/ollama
    ports:
      - 11434:11434
    volumes:
      - ollama:/root/.ollama
    networks:
      - pop

  init-ollama:
    container_name: pop-init-ollama
    image: centreonlabs/curl-jq:latest
    command: sh -c 
      "
      if [ $$(curl http://ollama:11434/api/tags | jq -r '.models | length') -eq 0 ]; then
        curl -s -X POST http://ollama:11434/api/pull -d '{\"name\":\"qwen2:0.5b\"}';
      fi
      "
    networks:
      - pop
    depends_on:
      - ollama

volumes:
  pop:
  ollama:

networks:
  pop: